# –°–∏—Å—Ç–µ–º–∞ –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–µ–∫—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –æ—á–∏—Å—Ç–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç –∏—Å—Ç–µ–∫—à–∏–µ –¥–∞–Ω–Ω—ã–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è —á–∏—Å—Ç–æ—Ç—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è —É—Å—Ç–∞—Ä–µ–≤—à–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.

## –ß—Ç–æ –æ—á–∏—â–∞–µ—Ç—Å—è

### 1. –°–µ—Å—Å–∏–∏ (sessions)
- **–£—Å–ª–æ–≤–∏–µ**: `expires_at <= datetime('now')`
- **–û–ø–∏—Å–∞–Ω–∏–µ**: –£–¥–∞–ª—è—é—Ç—Å—è —Å–µ—Å—Å–∏–∏ —Å –∏—Å—Ç–µ–∫—à–∏–º —Å—Ä–æ–∫–æ–º –¥–µ–π—Å—Ç–≤–∏—è

### 2. Magic Tokens (magic_tokens)
- **–£—Å–ª–æ–≤–∏–µ**: `expires_at <= datetime('now')` –ò–õ–ò `used_at <= datetime('now', '-1 hour')`
- **–û–ø–∏—Å–∞–Ω–∏–µ**: –£–¥–∞–ª—è—é—Ç—Å—è –∏—Å—Ç–µ–∫—à–∏–µ —Ç–æ–∫–µ–Ω—ã –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã —Å—Ç–∞—Ä—à–µ 1 —á–∞—Å–∞

### 3. Figma Auth Codes (figma_auth_codes)
- **–£—Å–ª–æ–≤–∏–µ**: `expires_at <= datetime('now')` –ò–õ–ò `used_at <= datetime('now', '-1 hour')`
- **–û–ø–∏—Å–∞–Ω–∏–µ**: –£–¥–∞–ª—è—é—Ç—Å—è –∏—Å—Ç–µ–∫—à–∏–µ –∫–æ–¥—ã –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–¥—ã —Å—Ç–∞—Ä—à–µ 1 —á–∞—Å–∞

## –ö–æ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –æ—á–∏—Å—Ç–∫–∞

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞
- **–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–∞**: –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –∫–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
- **–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏**: –ö–∞–∂–¥—ã–µ 24 —á–∞—Å–∞ (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ `CLEANUP_INTERVAL_HOURS`)
- **–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–µ—Å—Å–∏–∏**: –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å–µ—Å—Å–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5)

### –†—É—á–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
–ß–µ—Ä–µ–∑ API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã (—Ç—Ä–µ–±—É—é—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏):

```bash
# –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
POST /api/auth/cleanup

# –û—á–∏—Å—Ç–∫–∞ —Ç–æ–ª—å–∫–æ Figma –∫–æ–¥–æ–≤
POST /api/auth/cleanup-figma-codes

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
GET /api/auth/cleanup/status
```

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```bash
# –ò–Ω—Ç–µ—Ä–≤–∞–ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ (—á–∞—Å—ã)
CLEANUP_INTERVAL_HOURS=24

# –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ—Å—Å–∏–π –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
USER_SESSION_CLEANUP_LIMIT=5
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞
–ò–∑–º–µ–Ω–∏—Ç–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É –≤ —Ñ–∞–π–ª–µ `src/utils/cleanup-scheduler.ts`:
```typescript
const CLEANUP_INTERVAL_HOURS = 24; // –ò–∑–º–µ–Ω–∏—Ç–µ –Ω–∞ –Ω—É–∂–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏
–°–∏—Å—Ç–µ–º–∞ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ –ª–æ–≥–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–∂–¥–æ–π –æ—á–∏—Å—Ç–∫–µ:
```
üßπ –í—ã–ø–æ–ª–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é –æ—á–∏—Å—Ç–∫—É –∏—Å—Ç–µ–∫—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏...
üóëÔ∏è  –û—á–∏—â–µ–Ω–æ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ: 15 –∑–∞–ø–∏—Å–µ–π
–û—á–∏—â–µ–Ω–æ –∏—Å—Ç–µ–∫—à–∏—Ö —Å–µ—Å—Å–∏–π: 5
–û—á–∏—â–µ–Ω–æ magic tokens: 8 (–∏—Å—Ç–µ–∫—à–∏—Ö: 6, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö: 2)
–û—á–∏—â–µ–Ω–æ –∫–æ–¥–æ–≤ Figma: 2 (–∏—Å—Ç–µ–∫—à–∏—Ö: 1, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö: 1)
```

### API —Å—Ç–∞—Ç—É—Å
```json
{
  "cleanupScheduler": {
    "isRunning": true,
    "nextCleanup": "2024-01-15T14:30:00.000Z"
  },
  "lastCleanup": "2024-01-14T14:30:00.000Z"
}
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- **–ê—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏**: –í—Å–µ –æ—á–∏—Å—Ç–∫–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ —Ä–∞–º–∫–∞—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ë–î
- **–ó–∞—â–∏—Ç–∞ –æ—Ç –≥–æ–Ω–æ–∫**: –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –æ—á–∏—Å—Ç–æ–∫
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –¥–ª—è –∞—É–¥–∏—Ç–∞
- **Graceful shutdown**: –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- **–ë–∞—Ç—á–µ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞**: –û—á–∏—Å—Ç–∫–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–∞–∫–µ—Ç–∞–º–∏ –¥–ª—è –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ –Ω–∞–≥—Ä—É–∑–∫–∏
- **–ò–Ω–¥–µ–∫—Å—ã**: –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∏–Ω–¥–µ–∫—Å—ã –ø–æ `expires_at` –ø–æ–ª—è–º
- **–§–æ–Ω–æ–≤–∞—è —Ä–∞–±–æ—Ç–∞**: –û—á–∏—Å—Ç–∫–∞ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

## –û—Ç–ª–∞–¥–∫–∞

### –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
```bash
# –í –∫–æ–¥–µ —Å–µ—Ä–≤–µ—Ä–∞
import { runManualCleanup } from './utils/cleanup-scheduler.js';
const result = await runManualCleanup();
console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç –æ—á–∏—Å—Ç–∫–∏:', result);
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
```bash
# –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
GET /api/auth/cleanup/status
```

## –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ

–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—á–∏—Å—Ç–∫–∏:

1. **–°–æ–∑–¥–∞–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é –æ—á–∏—Å—Ç–∫–∏** –≤ `src/db/auth-queries.ts`
2. **–î–æ–±–∞–≤—å—Ç–µ –≤—ã–∑–æ–≤** –≤ `cleanupExpiredAuthData()`
3. **–û–±–Ω–æ–≤–∏—Ç–µ —Ç–∏–ø—ã** –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
4. **–î–æ–±–∞–≤—å—Ç–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –¥–ª—è –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏

–ü—Ä–∏–º–µ—Ä:
```typescript
export function cleanupExpiredTable(): number {
  const db = getDatabase();
  const result = db.prepare(`
    DELETE FROM your_table
    WHERE expires_at <= datetime('now')
  `).run();
  return result.changes;
}
```
