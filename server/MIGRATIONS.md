# Система миграций базы данных

## Обзор

Система миграций обеспечивает безопасное обновление схемы базы данных при развертывании новых версий приложения. Все миграции применяются автоматически при запуске сервера.

## Структура

- `src/db/migrations.ts` - основная система миграций
- `src/db/check-compatibility.ts` - проверка обратной совместимости
- `src/db/init.ts` - инициализация с применением миграций

## Применённые миграции

### Версия 1: initial_schema
- Создание базовых таблиц: `users`, `votings`, `voting_options`, `votes`
- Добавление индексов для производительности
- Поддержка анонимного режима (поля `user_id` nullable)

### Версия 2: add_magic_tokens
- Создание таблицы `magic_tokens` для авторизации по email
- Индекс по `expires_at` для очистки устаревших токенов

### Версия 3: add_sessions
- Создание таблицы `sessions` для refresh токенов
- Индексы по `user_id` и `expires_at`

### Версия 4: add_figma_auth_codes
- Создание таблицы `figma_auth_codes` для авторизации Figma-плагина
- Индекс по `expires_at` для очистки устаревших кодов

## Команды

```bash
# Проверить совместимость с анонимным режимом
bun run db:check-compatibility

# Применить миграции (автоматически при запуске сервера)
bun run dev
```

## Обратная совместимость

Система полностью совместима с анонимным режимом:

- ✅ Анонимные голосования (без `user_id`)
- ✅ Анонимные голоса (без `user_id`)
- ✅ Публичные голосования (`is_public = true`)
- ✅ Приватные голосования (`is_public = false`)
- ✅ Все таблицы авторизации созданы

## Добавление новых миграций

1. Добавьте новую миграцию в массив `migrations` в `migrations.ts`:

```typescript
{
  version: 5,
  name: 'add_new_feature',
  up: (db: Database) => {
    // SQL для применения миграции
    db.exec(`CREATE TABLE new_table (...)`);
  },
  down: (db: Database) => {
    // SQL для отката миграции (опционально)
    db.exec(`DROP TABLE new_table`);
  }
}
```

2. Миграция будет применена автоматически при следующем запуске сервера.

## Мониторинг

Таблица `schema_migrations` отслеживает применённые миграции:

```sql
SELECT * FROM schema_migrations ORDER BY version;
```

## Безопасность

- Все миграции применяются в транзакциях
- При ошибке миграция откатывается
- Существующие данные не теряются
- Поддержка `IF NOT EXISTS` для безопасного создания таблиц
