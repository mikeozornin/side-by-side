# Система уведомлений

Система уведомлений позволяет отправлять сообщения в чаты при создании новых сайд-бай-сайдов.

## Поддерживаемые провайдеры

- **Mattermost** - через webhook (реализован)
- **Telegram** - заготовка для будущего

## Настройка

### 1. ENV переменные

Скопируйте `env.example` в `.env` и настройте переменные:

```bash
# URL для ссылок на голосования (клиентская часть)
VOTING_BASE_URL=http://localhost:5173

# Уведомления в чаты
# Локализация уведомлений (ru/en)
NOTIFICATIONS_LOCALE=ru

# Mattermost
MATTERMOST_ENABLED=true
MATTERMOST_WEBHOOK_URL=https://your-mattermost-server.com/hooks/your-webhook-id

# Telegram (для будущего)
TELEGRAM_ENABLED=false
TELEGRAM_BOT_TOKEN=your-bot-token
TELEGRAM_CHAT_ID=your-chat-id
```

### 2. Настройка Mattermost Webhook

1. В Mattermost перейдите в **System Console** → **Integrations** → **Custom Integrations**
2. Включите **Enable Incoming Webhooks**
3. Создайте новый webhook:
   - Выберите канал для уведомлений
   - Скопируйте URL webhook'а
   - Вставьте в `MATTERMOST_WEBHOOK_URL`

## Тестирование

Запустите команду тестирования:

```bash
npm run test:notifications
```

Команда отправит тестовое сообщение во все активные провайдеры и покажет результаты.

### Тестирование локализации

```bash
npm run test:locale
```

Команда покажет текущую локаль и протестирует переводы на разных языках.

## Архитектура

```
server/src/notifications/
├── types.ts                    # Интерфейсы и типы
├── i18n.ts                     # Система локализации
├── notificationService.ts      # Основной сервис
├── locales/
│   ├── ru.json                # Русские переводы
│   └── en.json                # Английские переводы
├── providers/
│   ├── base.ts                # Базовый класс провайдера
│   ├── mattermost.ts          # Mattermost провайдер
│   └── telegram.ts            # Заготовка для Telegram
└── index.ts                   # Экспорты
```

## Добавление нового провайдера

1. Создайте новый класс, наследующий от `NotificationProvider`
2. Реализуйте методы `send()`, `validate()`, `name`
3. Добавьте провайдер в `NotificationService.initializeProviders()`
4. Добавьте соответствующие ENV переменные

## Формат сообщения

Сообщения отправляются в формате:

```
**Новый сайд-бай-сайд для голосования!**

[Название голосования](ссылка)
```

## Логирование

Все операции логируются через существующую систему логирования:
- Успешные отправки: `INFO` уровень
- Ошибки: `ERROR` уровень  
- Предупреждения: `WARN` уровень

**Примечание:** Логи пишутся на английском языке для универсальности.

## Локализация

Система поддерживает локализацию через файлы в `locales/`:
- `ru.json` - русские переводы (по умолчанию)
- `en.json` - английские переводы

### Настройка локали

**Через ENV переменную (рекомендуется):**
```bash
NOTIFICATIONS_LOCALE=en  # или ru
```

**Программно:**
```typescript
import { i18n } from './notifications/i18n.js';
i18n.setLocale('en'); // или 'ru'
```

### Поддерживаемые языки

- `ru` - Русский (по умолчанию)
- `en` - Английский

При неверном значении `NOTIFICATIONS_LOCALE` система автоматически использует русский язык и выводит предупреждение в лог.

### Особенности

- Все пользовательские сообщения (в консоли, уведомлениях) локализованы
- Логи остаются на английском для универсальности
- Система автоматически инициализируется с локалью из ENV при старте
