<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Side by side voting</title>
  <style>
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 11px;
      line-height: 16px;
      color: var(--figma-color-text);
      background: var(--figma-color-bg);
      padding: 16px;
      height: 100vh;
      overflow: hidden;
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100%;
      gap: 16px;
    }

    .status-container {
      min-height: 32px; /* Fixed height to prevent jumping - enough for status + 2 elements */
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .status {
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
      margin-bottom: 0; /* Remove margin since we use gap in container */
      display: flex;
      align-items: center;
    }

    .status.info {
      background: var(--figma-color-bg-brand-tertiary);
      color: var(--figma-color-text-brand);
      border: 1px solid var(--figma-color-border-brand);
    }

    .status.error {
      background: var(--figma-color-bg-danger-tertiary);
      color: var(--figma-color-text-danger);
      border: 1px solid var(--figma-color-border-danger);
    }

    .status.success {
      background: var(--figma-color-bg-success-tertiary);
      color: var(--figma-color-text-success);
      border: 1px solid var(--figma-color-border-success);
    }

    .status.warning {
      background: var(--figma-color-bg-warning-tertiary);
      color: var(--figma-color-text-warning);
      border: 1px solid var(--figma-color-border-warning);
    }

    .label {
      display: block;
      font-size: 11px;
      font-weight: 500;
      color: var(--figma-color-text-secondary);
      margin-bottom: 6px;
    }

    .input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--figma-color-border);
      border-radius: 6px;
      font-size: 12px;
      font-family: inherit;
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
      transition: border-color 0.2s;
    }

    .input:focus {
      outline: none;
      border-color: var(--figma-color-border-brand-strong);
      box-shadow: 0 0 0 2px var(--figma-color-bg-brand-tertiary);
    }

    .duration-options {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
      margin-top: 6px;
    }

    .duration-option {
      padding: 8px 12px;
      border: 1px solid var(--figma-color-border);
      border-radius: 6px;
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
      cursor: pointer;
      text-align: center;
      font-size: 11px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .duration-option:hover {
      border-color: var(--figma-color-border-brand-strong);
      background: var(--figma-color-bg-hover);
    }

    .duration-option.selected {
      border-color: var(--figma-color-border-selected);
      background: var(--figma-color-bg-pressed);
      color: var(--figma-color-text);
    }

    .selected-elements {
      display: flex;
      gap: 6px;
    }

    .element-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: var(--figma-color-bg-secondary);
      border-radius: 6px;
      border: 1px solid var(--figma-color-border);
      flex: 1;
      box-sizing: border-box;
    }

    .element-name {
      font-size: 11px;
      color: var(--figma-color-text);
      font-weight: 500;
    }

    .element-type {
      font-size: 10px;
      color: var(--figma-color-text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .button {
      width: 100%;
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }

    .button.primary {
      background: var(--figma-color-bg-brand);
      color: var(--figma-color-text-onbrand);
    }

    .button.primary:hover:not(:disabled) {
      background: var(--figma-color-bg-brand-hover);
    }

    .button.primary:disabled {
      background: var(--figma-color-bg-disabled);
      color: var(--figma-color-text-disabled);
      cursor: not-allowed;
    }

    .progress {
      display: none;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--figma-color-bg-brand-tertiary);
      border-radius: 6px;
      font-size: 11px;
      color: var(--figma-color-text-brand);
    }

    .spinner {
      width: 12px;
      height: 12px;
      border: 2px solid var(--figma-color-bg-brand-tertiary);
      border-top: 2px solid var(--figma-color-icon-brand);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .hidden {
      display: none !important;
    }

    .footer {
      margin-top: auto;
      padding-top: 16px;
    }

    .footer-text {
      font-size: 10px;
      color: var(--figma-color-text-tertiary);
      text-align: center;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="form-group">
      <label class="label" for="server-url">Server URL</label>
      <input type="url" id="server-url" class="input" value="localhost:3000" />
    </div>

    <div class="status-container">
      <div id="status" class="status info hidden">Checking selected elements...</div>
      <div id="selected-elements" class="selected-elements hidden"></div>
    </div>

    <div class="form-group">
      <label class="label" for="title">Question</label>
      <input type="text" id="title" class="input" maxlength="100" autofocus />
    </div>

    <div class="form-group">
      <label class="label" for="duration-options">Duration</label>
      <div class="duration-options" id="duration-options">
      <div class="duration-option" data-duration="0.167">10 min</div>
      <div class="duration-option" data-duration="1">1 h</div>
      <div class="duration-option" data-duration="2">2 h</div>
      <div class="duration-option" data-duration="3">3 h</div>
      <div class="duration-option" data-duration="5">5 h</div>
      <div class="duration-option" data-duration="8">8 h</div>
      <div class="duration-option selected" data-duration="24">1 day</div>
      <div class="duration-option" data-duration="168">7 days</div>
      </div>
    </div>

    <div id="progress" class="progress">
      <div class="spinner"></div>
      <span id="progress-message">Creating voting...</span>
    </div>

    <div class="footer">
      <button type="button" id="create-button" class="button primary" disabled>Create</button>
    </div>
  </div>

  <script>
    var defaultQuestions = [
      'Which option is better?',
      'Left or right?',
      'Right or left?',
      'Which is better on the left or right?',
      'Which is better on the right or left?',
      'Which design do you like more?',
      'Which option is better?',
      'What would you choose?',
      'What would you prefer?'
    ];

    var statusEl = document.getElementById('status');
    var selectedElementsEl = document.getElementById('selected-elements');
    var votingFormEl = document.getElementById('voting-form');
    var titleInput = document.getElementById('title');
    var durationOptionsEl = document.getElementById('duration-options');
    var createButton = document.getElementById('create-button');
    var progressEl = document.getElementById('progress');
    var progressMessageEl = document.getElementById('progress-message');
    var instructionFooterEl = document.getElementById('instruction-footer');
    var serverUrlInput = document.getElementById('server-url');

    var selectedDuration = 24;
    var selectedElements = [];
    var currentStatus = 'ready'; // Track current selection status

    // Storage keys
    var STORAGE_KEYS = {
      SERVER_URL: 'figma-plugin-server-url',
      DURATION: 'figma-plugin-duration'
    };

    // Load settings by requesting from main script
    function loadSettings() {
      console.log('Requesting settings from main script...');
      parent.postMessage({
        pluginMessage: {
          type: 'load-settings'
        }
      }, '*');
    }

    // Save settings by sending to main script
    function saveSettings() {
      console.log('Saving settings via main script...');
      var settings = {};

      if (serverUrlInput && serverUrlInput.value) {
        settings.serverUrl = serverUrlInput.value;
      }
      settings.duration = selectedDuration;

      parent.postMessage({
        pluginMessage: {
          type: 'save-settings',
          settings: settings
        }
      }, '*');
    }

    // Update duration selection in UI
    function updateDurationSelection(duration) {
      if (!durationOptionsEl) return;
      var options = durationOptionsEl.querySelectorAll('.duration-option');
      for (var i = 0; i < options.length; i++) {
        var option = options[i];
        var optionDuration = parseFloat(option.getAttribute('data-duration'));
        if (Math.abs(optionDuration - duration) < 0.001) {
          option.classList.add('selected');
        } else {
          option.classList.remove('selected');
        }
      }
    }

    function extractRootUrl(url) {
      try {
        if (url.indexOf('http://') !== 0 && url.indexOf('https://') !== 0) {
          url = 'http://' + url;
        }
        var urlObj = new URL(url);
        return urlObj.protocol + '//' + urlObj.host;
      } catch (error) {
        return url;
      }
    }

    function setupEventListeners() {
      if (votingFormEl) {
        votingFormEl.addEventListener('submit', handleCreateVotingSubmit);
      }
      if (createButton) {
        createButton.addEventListener('click', handleCreateVotingSubmit);
      }
      if (titleInput) {
        titleInput.addEventListener('input', updateCreateButtonState);
        titleInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' && !createButton.disabled) {
            handleCreateVotingSubmit(e);
          }
        });
      }
      if (serverUrlInput) {
        serverUrlInput.addEventListener('input', saveSettings);
        serverUrlInput.addEventListener('blur', saveSettings);
      }
      setupTitleSuggestions();
      setupDurationOptions();
    }

    function setupTitleSuggestions() {
      var randomQuestion = defaultQuestions[Math.floor(Math.random() * defaultQuestions.length)];
      if (titleInput) {
        titleInput.value = randomQuestion;
        updateCreateButtonState();
      }
    }

    function setupDurationOptions() {
      if (!durationOptionsEl) return;
      durationOptionsEl.addEventListener('click', function (e) {
        var target = e.target;
        if (target && target.classList && target.classList.contains('duration-option')) {
          var options = durationOptionsEl.querySelectorAll('.duration-option');
          for (var i = 0; i < options.length; i++) {
            options[i].classList.remove('selected');
          }
          target.classList.add('selected');
          selectedDuration = parseFloat(target.getAttribute('data-duration') || '24');
          saveSettings(); // Save duration when changed
        }
      });
    }

    function updateCreateButtonState() {
      var hasTitle = !!(titleInput && titleInput.value && titleInput.value.trim().length > 0);
      var hasElements = selectedElements.length === 2;
      var isStatusReady = currentStatus === 'ready';
      if (createButton) {
        createButton.disabled = !hasTitle || !hasElements || !isStatusReady;
      }
    }

    function handleCreateVotingSubmit(e) {
      e.preventDefault();
      var title = titleInput && titleInput.value ? titleInput.value.trim() : '';
      if (!title) {
        showStatus('error', 'Enter voting title');
        return;
      }
      if (selectedElements.length !== 2) {
        showStatus('error', 'Select exactly two elements');
        return;
      }
      var serverUrl = serverUrlInput && serverUrlInput.value ? serverUrlInput.value.trim() : '';
      if (!serverUrl) {
        showStatus('error', 'Enter server URL');
        return;
      }
      var rootUrl = extractRootUrl(serverUrl);
      showProgress('Creating voting...');
      parent.postMessage({
        pluginMessage: {
          type: 'create-voting',
          data: { title: title, duration: selectedDuration, serverUrl: rootUrl }
        }
      }, '*');
    }

    function showStatus(type, message) {
      if (statusEl) {
        statusEl.className = 'status ' + type;
        statusEl.innerHTML = message;
        statusEl.classList.remove('hidden');
      }
      if (progressEl) { progressEl.classList.add('hidden'); }
    }

    function showProgress(message) {
      if (progressMessageEl) { progressMessageEl.textContent = message; }
      if (progressEl) { progressEl.classList.remove('hidden'); }
      if (statusEl) { statusEl.classList.add('hidden'); }
    }

    function hideProgress() {
      if (progressEl) { progressEl.classList.add('hidden'); }
    }

    function updateSelectedElements(elements) {
      selectedElements = elements || [];
      if (selectedElements.length === 0) {
        if (selectedElementsEl) { selectedElementsEl.classList.add('hidden'); }
        if (instructionFooterEl) { instructionFooterEl.classList.remove('hidden'); }
        return;
      }
      if (selectedElementsEl) {
        selectedElementsEl.classList.remove('hidden');
        var html = '';
        for (var i = 0; i < selectedElements.length; i++) {
          var element = selectedElements[i];
          html += '<div class="element-item">' +
            '<div class="element-name">' + element.name + '</div>' +
            '<div class="element-type">' + element.type + '</div>' +
            '</div>';
        }
        selectedElementsEl.innerHTML = html;
      }
      if (instructionFooterEl) { instructionFooterEl.classList.add('hidden'); }
      updateCreateButtonState();
    }

    window.addEventListener('message', function (event) {
      var pm = event && event.data ? event.data.pluginMessage : null;
      if (!pm) return;
      var type = pm.type;
      var data = {};
      for (var key in pm) { if (key !== 'type') { data[key] = pm[key]; } }
      if (type === 'selection-status') {
        handleSelectionStatus(pm);
      } else if (type === 'export-progress') {
        showProgress(pm.message);
      } else if (type === 'voting-created') {
        handleVotingCreated(pm);
      } else if (type === 'open-url') {
        handleOpenUrl(pm);
      } else if (type === 'error') {
        handleError(pm);
      } else if (type === 'settings-loaded') {
        handleSettingsLoaded(pm);
      }
    });

    function handleSelectionStatus(data) {
      var status = data.status;
      var message = data.message;
      var elements = data.elements;
      currentStatus = status; // Update current status
      if (status === 'none') {
        showStatus('info', message);
        if (votingFormEl) { votingFormEl.classList.add('hidden'); }
        updateSelectedElements([]);
      } else if (status === 'partial') {
        showStatus('warning', message);
        if (votingFormEl) { votingFormEl.classList.add('hidden'); }
        updateSelectedElements([]);
      } else if (status === 'too-many') {
        showStatus('error', message);
        if (votingFormEl) { votingFormEl.classList.add('hidden'); }
        updateSelectedElements([]);
      } else if (status === 'ready') {
        // Hide status - just show form and update elements
        if (statusEl) { statusEl.classList.add('hidden'); }
        if (votingFormEl) { votingFormEl.classList.remove('hidden'); }
        updateSelectedElements(elements);
      }
      updateCreateButtonState(); // Update button state based on new status
      hideProgress();
    }

    function handleVotingCreated(data) {
      var url = data.url;
      showStatus('success', 'Voting created! <a href="' + url + '" target="_blank" style="color: #007AFF; text-decoration: underline;">Open in browser</a>');
      setTimeout(function () {
        parent.postMessage({ pluginMessage: { type: 'close-plugin' } }, '*');
      }, 5000);
    }

    function handleOpenUrl(data) {
      var url = data.url;
      window.open(url, '_blank');
      parent.postMessage({ pluginMessage: { type: 'url-opened', message: 'Link opened in browser!' } }, '*');
    }

    function handleError(data) {
      var message = data.message;
      showStatus('error', message);
      hideProgress();
    }

    function handleSettingsLoaded(data) {
      console.log('Settings loaded:', data.settings);
      var settings = data.settings || {};

      // Load server URL
      if (settings.serverUrl && serverUrlInput) {
        serverUrlInput.value = settings.serverUrl;
        console.log('Set server URL input to:', settings.serverUrl);
      }

      // Load duration
      if (settings.duration) {
        selectedDuration = parseFloat(settings.duration);
        updateDurationSelection(selectedDuration);
        console.log('Set duration to:', selectedDuration);
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function () {
      loadSettings(); // Load saved settings first
      setupEventListeners();
      updateCreateButtonState();
      
      // Set focus to title input after a short delay to ensure it's ready
      setTimeout(function() {
        if (titleInput) {
          titleInput.focus();
        }
      }, 100);
    });
  </script>
</body>

</html>