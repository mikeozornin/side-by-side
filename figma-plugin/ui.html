<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Side-by-Side Voting</title>
  <style>
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 11px;
      line-height: 16px;
      color: var(--figma-color-text);
      background: var(--figma-color-bg);
      padding: 16px;
      height: 100vh;
      overflow: hidden;
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100%;
      gap: 16px;
    }

    .status-container {
      min-height: 32px; /* Fixed height to prevent jumping - enough for status + 2 elements */
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .status {
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
      margin-bottom: 0; /* Remove margin since we use gap in container */
      display: flex;
      align-items: center;
    }

    .status.info {
      background: var(--figma-color-bg-brand-tertiary);
      color: var(--figma-color-text-brand);
      border: 1px solid var(--figma-color-border-brand);
    }

    .status.error {
      background: var(--figma-color-bg-danger-tertiary);
      color: var(--figma-color-text-danger);
      border: 1px solid var(--figma-color-border-danger);
    }

    .status.success {
      background: var(--figma-color-bg-success-tertiary);
      color: var(--figma-color-text-success);
      border: 1px solid var(--figma-color-border-success);
    }

    .status.warning {
      background: var(--figma-color-bg-warning-tertiary);
      color: var(--figma-color-text-warning);
      border: 1px solid var(--figma-color-border-warning);
    }

    .label {
      display: block;
      font-size: 11px;
      font-weight: 500;
      color: var(--figma-color-text-secondary);
      margin-bottom: 6px;
    }

    .input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--figma-color-border);
      border-radius: 6px;
      font-size: 12px;
      font-family: inherit;
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
      transition: border-color 0.2s;
    }

    .input:focus {
      outline: none;
      border-color: var(--figma-color-border-brand-strong);
      box-shadow: 0 0 0 2px var(--figma-color-bg-brand-tertiary);
    }

    .input:disabled {
      background: var(--figma-color-bg-disabled);
      color: var(--figma-color-text-disabled);
      border-color: var(--figma-color-border-disabled);
      cursor: not-allowed;
    }

    .duration-options {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
      margin-top: 6px;
    }

    .duration-option {
      padding: 8px 12px;
      border: 1px solid var(--figma-color-border);
      border-radius: 6px;
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
      cursor: pointer;
      text-align: center;
      font-size: 11px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .duration-option:hover {
      border-color: var(--figma-color-border-brand-strong);
      background: var(--figma-color-bg-hover);
    }

    .duration-option.selected {
      border-color: var(--figma-color-border-selected);
      background: var(--figma-color-bg-pressed);
      color: var(--figma-color-text);
    }

    .selected-elements {
      display: flex;
      gap: 6px;
    }

    .element-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: var(--figma-color-bg-secondary);
      border-radius: 6px;
      border: 1px solid var(--figma-color-border);
      flex: 1;
      box-sizing: border-box;
    }

    .element-name {
      font-size: 11px;
      color: var(--figma-color-text);
      font-weight: 500;
    }

    .element-type {
      font-size: 10px;
      color: var(--figma-color-text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .button {
      width: 100%;
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }

    .button.primary {
      background: var(--figma-color-bg-brand);
      color: var(--figma-color-text-onbrand);
    }

    .button.primary:hover:not(:disabled) {
      background: var(--figma-color-bg-brand-hover);
    }

    .button.primary:disabled {
      background: var(--figma-color-bg-disabled);
      color: var(--figma-color-text-disabled);
      cursor: not-allowed;
    }

    .progress {
      display: none;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--figma-color-bg-brand-tertiary);
      border-radius: 6px;
      font-size: 11px;
      color: var(--figma-color-text-brand);
    }

    .spinner {
      width: 12px;
      height: 12px;
      border: 2px solid var(--figma-color-bg-brand-tertiary);
      border-top: 2px solid var(--figma-color-icon-brand);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .hidden {
      display: none !important;
    }

    .footer {
      margin-top: auto;
      padding-top: 16px;
    }

    .login-form .footer {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .footer-text {
      font-size: 10px;
      color: var(--figma-color-text-tertiary);
      text-align: center;
    }

    .login-form {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .main-interface {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .server-info {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .server-info .input {
      flex: 1;
    }

    .logout-btn {
      width: 32px;
      height: 32px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--figma-color-border);
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
    }

    .logout-btn:hover {
      background: var(--figma-color-bg-hover);
      border-color: var(--figma-color-border-brand-strong);
    }

    .button.secondary {
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
      border: 1px solid var(--figma-color-border);
    }

    .button.secondary:hover:not(:disabled) {
      background: var(--figma-color-bg-hover);
      border-color: var(--figma-color-border-brand-strong);
    }

    .help-text {
      font-size: 11px;
      color: var(--figma-color-text);
      text-align: left;
      margin-top: 8px;
      line-height: 1.4;
    }

    .help-text a {
      color: var(--figma-color-text-brand);
      text-decoration: underline;
    }

    .help-text a:hover {
      color: var(--figma-color-text-brand-strong);
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Login Form (shown when not authenticated) -->
    <div id="login-form" class="login-form">
      <div class="form-group">
        <label class="label" for="login-server-url">Server URL</label>
        <input type="url" id="login-server-url" class="input" placeholder="localhost:3000" />
      </div>

      <div class="form-group">
        <label class="label" for="login-auth-code">Authentication Code</label>
        <input type="text" id="login-auth-code" class="input" placeholder="FGM-XXXXXX" />
      </div>

      <div class="footer">
        <button type="button" id="login-button" class="button primary">Login</button>
        <div class="help-text">
          Get your code from the web app settings page at <a href="#" id="settings-link">localhost:5173/#/settings</a>
        </div>
      </div>
    </div>

    <!-- Main Plugin Interface (shown when authenticated) -->
    <div id="main-interface" class="main-interface hidden">
      <!-- Server URL and Logout -->
      <div class="server-info">
        <input type="url" id="server-url-display" class="input" disabled />
        <button type="button" id="logout-button" class="button secondary logout-btn" title="Logout">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16,17 21,12 16,7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
        </button>
      </div>

      <div class="status-container">
        <div id="status" class="status info hidden">Checking selected elements...</div>
        <div id="selected-elements" class="selected-elements hidden"></div>
      </div>

      <div class="form-group">
        <label class="label" for="title">Question</label>
        <input type="text" id="title" class="input" maxlength="100" />
      </div>

      <div class="form-group">
        <label class="label" for="duration-options">Duration</label>
        <div class="duration-options" id="duration-options">
        <div class="duration-option" data-duration="0.167">10 min</div>
        <div class="duration-option" data-duration="1">1 h</div>
        <div class="duration-option" data-duration="2">2 h</div>
        <div class="duration-option" data-duration="3">3 h</div>
        <div class="duration-option" data-duration="5">5 h</div>
        <div class="duration-option" data-duration="8">8 h</div>
        <div class="duration-option selected" data-duration="24">1 day</div>
        <div class="duration-option" data-duration="168">7 days</div>
        </div>
      </div>

      <div class="form-group">
        <label class="label" for="privacy-options">Visibility</label>
        <div class="duration-options" id="privacy-options">
        <div class="duration-option selected" data-privacy="true">Public</div>
        <div class="duration-option" data-privacy="false">Private</div>
        </div>
      </div>

      <div id="progress" class="progress">
        <div class="spinner"></div>
        <span id="progress-message">Creating voting...</span>
      </div>

      <div class="footer">
        <button type="button" id="create-button" class="button primary" disabled>Create</button>
      </div>
    </div>
  </div>

  <script>
    var defaultQuestions = [
      'Which option is better?',
      'Left or right?',
      'Right or left?',
      'Which is better on the left or right?',
      'Which is better on the right or left?',
      'Which design do you like more?',
      'Which option is better?',
      'What would you choose?',
      'What would you prefer?'
    ];

    var statusEl = document.getElementById('status');
    var selectedElementsEl = document.getElementById('selected-elements');
    var titleInput = document.getElementById('title');
    var durationOptionsEl = document.getElementById('duration-options');
    var createButton = document.getElementById('create-button');
    var progressEl = document.getElementById('progress');
    var progressMessageEl = document.getElementById('progress-message');
    
    // Login form elements
    var loginFormEl = document.getElementById('login-form');
    var mainInterfaceEl = document.getElementById('main-interface');
    var loginServerUrlInput = document.getElementById('login-server-url');
    var loginAuthCodeInput = document.getElementById('login-auth-code');
    var loginButton = document.getElementById('login-button');
    var serverUrlDisplayInput = document.getElementById('server-url-display');
    var logoutButton = document.getElementById('logout-button');

    var selectedDuration = 24;
    var selectedPrivacy = true; // true = public, false = private
    var selectedElements = [];
    var currentStatus = 'ready'; // Track current selection status
    var authCode = '';
    var isAuthenticated = false;
    var currentServerUrl = '';

    // Storage keys
    var STORAGE_KEYS = {
      SERVER_URL: 'figma-plugin-server-url',
      DURATION: 'figma-plugin-duration',
      PRIVACY: 'figma-plugin-privacy'
    };

    // Load settings by requesting from main script
    function loadSettings() {
      console.log('Requesting settings from main script...');
      parent.postMessage({
        pluginMessage: {
          type: 'load-settings'
        }
      }, '*');
    }

    // Check authentication status
    function checkAuthStatus() {
      console.log('Checking authentication status...');
      parent.postMessage({
        pluginMessage: {
          type: 'check-auth-status'
        }
      }, '*');
    }

    // Show login form
    function showLoginForm() {
      if (loginFormEl) loginFormEl.classList.remove('hidden');
      if (mainInterfaceEl) mainInterfaceEl.classList.add('hidden');
    }

    // Show main interface
    function showMainInterface() {
      if (loginFormEl) loginFormEl.classList.add('hidden');
      if (mainInterfaceEl) mainInterfaceEl.classList.remove('hidden');
    }

    // Handle login
    function handleLogin() {
      var serverUrl = loginServerUrlInput && loginServerUrlInput.value ? loginServerUrlInput.value.trim() : '';
      var authCode = loginAuthCodeInput && loginAuthCodeInput.value ? loginAuthCodeInput.value.trim() : '';
      
      if (!serverUrl) {
        showStatus('error', 'Enter server URL');
        return;
      }
      
      if (!authCode) {
        showStatus('error', 'Enter authentication code');
        return;
      }

      var rootUrl = extractRootUrl(serverUrl);
      currentServerUrl = rootUrl;
      
      showProgress('Verifying code...');
      
      parent.postMessage({
        pluginMessage: {
          type: 'login',
          data: { serverUrl: rootUrl, authCode: authCode }
        }
      }, '*');
    }

    // Handle logout
    function handleLogout() {
      isAuthenticated = false;
      currentServerUrl = '';
      
      if (serverUrlDisplayInput) serverUrlDisplayInput.value = '';
      if (loginServerUrlInput) loginServerUrlInput.value = '';
      if (loginAuthCodeInput) loginAuthCodeInput.value = '';
      
      showLoginForm();
      
      parent.postMessage({
        pluginMessage: {
          type: 'logout'
        }
      }, '*');
    }

    // Update settings link based on server URL
    function updateSettingsLink() {
      var settingsLink = document.getElementById('settings-link');
      if (!settingsLink) return;
      
      var serverUrl = loginServerUrlInput && loginServerUrlInput.value ? loginServerUrlInput.value.trim() : 'localhost:3000';
      var rootUrl = extractRootUrl(serverUrl);
      
      // Extract domain and port from server URL
      var urlObj;
      try {
        urlObj = new URL(rootUrl);
        var domain = urlObj.hostname;
        var port = urlObj.port;
        
        // For client URL, use port 5173 instead of server port
        var clientPort = port ? '5173' : '';
        var displayText = domain + (clientPort ? ':' + clientPort : '') + '/#/settings';
        var settingsUrl = rootUrl.replace(':' + port, ':5173') + '/#/settings';
        
        settingsLink.textContent = displayText;
        settingsLink.href = settingsUrl;
      } catch (error) {
        // Fallback for invalid URLs
        var displayText = 'localhost:5173/#/settings';
        var settingsUrl = 'http://localhost:5173/#/settings';
        
        settingsLink.textContent = displayText;
        settingsLink.href = settingsUrl;
      }
    }

    // Save settings by sending to main script
    function saveSettings() {
      console.log('Saving settings via main script...');
      var settings = {};

      // Save server URL from login form
      if (loginServerUrlInput && loginServerUrlInput.value) {
        settings.serverUrl = loginServerUrlInput.value;
      }
      
      settings.duration = selectedDuration;
      settings.privacy = selectedPrivacy;

      parent.postMessage({
        pluginMessage: {
          type: 'save-settings',
          settings: settings
        }
      }, '*');
    }

    // Update duration selection in UI
    function updateDurationSelection(duration) {
      if (!durationOptionsEl) return;
      var options = durationOptionsEl.querySelectorAll('.duration-option');
      for (var i = 0; i < options.length; i++) {
        var option = options[i];
        var optionDuration = parseFloat(option.getAttribute('data-duration'));
        if (Math.abs(optionDuration - duration) < 0.001) {
          option.classList.add('selected');
        } else {
          option.classList.remove('selected');
        }
      }
    }

    // Update privacy selection in UI
    function updatePrivacySelection(privacy) {
      var privacyOptionsEl = document.getElementById('privacy-options');
      if (!privacyOptionsEl) return;
      var options = privacyOptionsEl.querySelectorAll('.duration-option');
      for (var i = 0; i < options.length; i++) {
        var option = options[i];
        var optionPrivacy = option.getAttribute('data-privacy') === 'true';
        if (optionPrivacy === privacy) {
          option.classList.add('selected');
        } else {
          option.classList.remove('selected');
        }
      }
    }

    function extractRootUrl(url) {
      try {
        if (url.indexOf('http://') !== 0 && url.indexOf('https://') !== 0) {
          url = 'http://' + url;
        }
        var urlObj = new URL(url);
        return urlObj.protocol + '//' + urlObj.host;
      } catch (error) {
        return url;
      }
    }

    function setupEventListeners() {
      // Login form events
      if (loginButton) {
        loginButton.addEventListener('click', handleLogin);
      }
      if (loginAuthCodeInput) {
        loginAuthCodeInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            handleLogin();
          }
        });
      }
      if (loginServerUrlInput) {
        loginServerUrlInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            handleLogin();
          }
        });
        loginServerUrlInput.addEventListener('input', function() {
          updateSettingsLink();
          saveSettings();
        });
        loginServerUrlInput.addEventListener('blur', saveSettings);
      }
      
      // Logout button
      if (logoutButton) {
        logoutButton.addEventListener('click', handleLogout);
      }
      
      // Settings link
      var settingsLink = document.getElementById('settings-link');
      if (settingsLink) {
        settingsLink.addEventListener('click', function(e) {
          e.preventDefault();
          var serverUrl = loginServerUrlInput && loginServerUrlInput.value ? loginServerUrlInput.value.trim() : 'localhost:3000';
          var rootUrl = extractRootUrl(serverUrl);
          
          // Extract domain and port from server URL
          var urlObj;
          try {
            urlObj = new URL(rootUrl);
            var port = urlObj.port;
            var settingsUrl = rootUrl.replace(':' + port, ':5173') + '/#/settings';
          } catch (error) {
            var settingsUrl = 'http://localhost:5173/#/settings';
          }
          
          parent.postMessage({
            pluginMessage: {
              type: 'open-url',
              data: { url: settingsUrl }
            }
          }, '*');
        });
      }
      
      // Main interface events
      if (createButton) {
        createButton.addEventListener('click', handleCreateVotingSubmit);
      }
      if (titleInput) {
        titleInput.addEventListener('input', updateCreateButtonState);
        titleInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' && !createButton.disabled) {
            handleCreateVotingSubmit(e);
          }
        });
      }
      
      setupTitleSuggestions();
      setupDurationOptions();
      setupPrivacyOptions();
    }

    function setupTitleSuggestions() {
      var randomQuestion = defaultQuestions[Math.floor(Math.random() * defaultQuestions.length)];
      if (titleInput) {
        titleInput.value = randomQuestion;
        updateCreateButtonState();
      }
    }

    function setupDurationOptions() {
      if (!durationOptionsEl) return;
      durationOptionsEl.addEventListener('click', function (e) {
        var target = e.target;
        if (target && target.classList && target.classList.contains('duration-option')) {
          var options = durationOptionsEl.querySelectorAll('.duration-option');
          for (var i = 0; i < options.length; i++) {
            options[i].classList.remove('selected');
          }
          target.classList.add('selected');
          selectedDuration = parseFloat(target.getAttribute('data-duration') || '24');
          saveSettings(); // Save duration when changed
        }
      });
    }

    function setupPrivacyOptions() {
      var privacyOptionsEl = document.getElementById('privacy-options');
      if (!privacyOptionsEl) return;
      privacyOptionsEl.addEventListener('click', function (e) {
        var target = e.target;
        if (target && target.classList && target.classList.contains('duration-option')) {
          var options = privacyOptionsEl.querySelectorAll('.duration-option');
          for (var i = 0; i < options.length; i++) {
            options[i].classList.remove('selected');
          }
          target.classList.add('selected');
          selectedPrivacy = target.getAttribute('data-privacy') === 'true';
          saveSettings(); // Save privacy when changed
        }
      });
    }

    function updateCreateButtonState() {
      var hasTitle = !!(titleInput && titleInput.value && titleInput.value.trim().length > 0);
      var hasElements = selectedElements.length >= 2 && selectedElements.length <= 10;
      var isStatusReady = currentStatus === 'ready';
      var hasAuth = isAuthenticated;
      if (createButton) {
        createButton.disabled = !hasTitle || !hasElements || !isStatusReady || !hasAuth;
      }
    }


    function handleCreateVotingSubmit(e) {
      e.preventDefault();
      var title = titleInput && titleInput.value ? titleInput.value.trim() : '';
      if (!title) {
        showStatus('error', 'Enter voting title');
        return;
      }
      if (selectedElements.length < 2 || selectedElements.length > 10) {
        showStatus('error', 'Select between 2 and 10 elements');
        return;
      }
      if (!currentServerUrl) {
        showStatus('error', 'Not authenticated');
        return;
      }
      showProgress('Creating voting...');
      parent.postMessage({
        pluginMessage: {
          type: 'create-voting',
          data: { title: title, duration: selectedDuration, privacy: selectedPrivacy, serverUrl: currentServerUrl }
        }
      }, '*');
    }

    function showStatus(type, message) {
      if (statusEl) {
        statusEl.className = 'status ' + type;
        statusEl.innerHTML = message;
        statusEl.classList.remove('hidden');
      }
      if (progressEl) { progressEl.classList.add('hidden'); }
    }

    function showProgress(message) {
      if (progressMessageEl) { progressMessageEl.textContent = message; }
      if (progressEl) { progressEl.classList.remove('hidden'); }
      if (statusEl) { statusEl.classList.add('hidden'); }
    }

    function hideProgress() {
      if (progressEl) { progressEl.classList.add('hidden'); }
    }

    function updateSelectedElements(elements) {
      selectedElements = elements || [];
      if (selectedElements.length === 0) {
        if (selectedElementsEl) { selectedElementsEl.classList.add('hidden'); }
        return;
      }
      if (selectedElementsEl) {
        selectedElementsEl.classList.remove('hidden');
        var html = '';
        for (var i = 0; i < selectedElements.length; i++) {
          var element = selectedElements[i];
          html += '<div class="element-item">' +
            '<div class="element-name">' + element.name + '</div>' +
            '<div class="element-type">' + element.type + '</div>' +
            '</div>';
        }
        selectedElementsEl.innerHTML = html;
      }
      updateCreateButtonState();
    }

    window.addEventListener('message', function (event) {
      var pm = event && event.data ? event.data.pluginMessage : null;
      if (!pm) return;
      var type = pm.type;
      var data = {};
      for (var key in pm) { if (key !== 'type') { data[key] = pm[key]; } }
      if (type === 'selection-status') {
        handleSelectionStatus(pm);
      } else if (type === 'export-progress') {
        showProgress(pm.message);
      } else if (type === 'voting-created') {
        handleVotingCreated(pm);
      } else if (type === 'open-url') {
        handleOpenUrl(pm);
      } else if (type === 'error') {
        handleError(pm);
      } else if (type === 'settings-loaded') {
        handleSettingsLoaded(pm);
      } else if (type === 'auth-verified') {
        handleAuthVerified(pm);
      } else if (type === 'auth-error') {
        handleAuthError(pm);
      } else if (type === 'login-success') {
        handleLoginSuccess(pm);
      } else if (type === 'login-error') {
        handleLoginError(pm);
      } else if (type === 'auth-status') {
        handleAuthStatus(pm);
      }
    });

    function handleSelectionStatus(data) {
      var status = data.status;
      var message = data.message;
      var elements = data.elements;
      currentStatus = status; // Update current status
      if (status === 'none') {
        showStatus('info', message);
        updateSelectedElements([]);
      } else if (status === 'partial') {
        showStatus('warning', message);
        updateSelectedElements([]);
      } else if (status === 'too-many') {
        showStatus('error', message);
        updateSelectedElements([]);
      } else if (status === 'ready') {
        // Hide status - just show form and update elements
        if (statusEl) { statusEl.classList.add('hidden'); }
        updateSelectedElements(elements);
      }
      updateCreateButtonState(); // Update button state based on new status
      hideProgress();
    }

    function handleVotingCreated(data) {
      var url = data.url;
      showStatus('success', 'Voting created! <a href="' + url + '" target="_blank" style="color: #007AFF; text-decoration: underline;">Open in browser</a>');
      setTimeout(function () {
        parent.postMessage({ pluginMessage: { type: 'close-plugin' } }, '*');
      }, 5000);
    }

    function handleOpenUrl(data) {
      var url = data.url;
      window.open(url, '_blank');
      parent.postMessage({ pluginMessage: { type: 'url-opened', message: 'Link opened in browser!' } }, '*');
    }

    function handleError(data) {
      var message = data.message;
      
      // Handle rate limiting errors with localized messages
      if (message === 'RATE_LIMIT_MINUTE_EXCEEDED') {
        message = 'Too many voting creation requests. Please try again in a minute.';
      } else if (message === 'RATE_LIMIT_HOUR_EXCEEDED') {
        message = 'Voting creation limit exceeded for the hour. Please try again later.';
      } else if (message === 'RATE_LIMIT_EXCEEDED') {
        message = 'Request limit exceeded. Please try again later.';
      }
      
      showStatus('error', message);
      hideProgress();
    }

    function handleSettingsLoaded(data) {
      console.log('Settings loaded:', data.settings);
      var settings = data.settings || {};

      // Load server URL
      if (settings.serverUrl && loginServerUrlInput) {
        loginServerUrlInput.value = settings.serverUrl;
        updateSettingsLink();
        console.log('Set server URL input to:', settings.serverUrl);
      }

      // Load duration
      if (settings.duration) {
        selectedDuration = parseFloat(settings.duration);
        updateDurationSelection(selectedDuration);
        console.log('Set duration to:', selectedDuration);
      }

      // Load privacy
      if (settings.privacy !== undefined) {
        selectedPrivacy = settings.privacy === true || settings.privacy === 'true';
        updatePrivacySelection(selectedPrivacy);
        console.log('Set privacy to:', selectedPrivacy);
      }
      
      updateCreateButtonState();
    }

    function handleAuthVerified(data) {
      isAuthenticated = true;
      hideProgress();
      showStatus('success', 'Authentication successful!');
      updateCreateButtonState();
    }

    function handleAuthError(data) {
      isAuthenticated = false;
      hideProgress();
      var message = data.message || 'Authentication failed';
      showStatus('error', message);
      updateCreateButtonState();
    }

    function handleLoginSuccess(data) {
      isAuthenticated = true;
      hideProgress();
      showStatus('success', 'Login successful!');
      
      // Update server URL display
      if (serverUrlDisplayInput) {
        serverUrlDisplayInput.value = currentServerUrl;
      }
      
      // Show main interface
      showMainInterface();
      
      // Load settings for main interface
      loadSettings();
    }

    function handleLoginError(data) {
      isAuthenticated = false;
      hideProgress();
      var message = data.message || 'Login failed';
      showStatus('error', message);
    }

    function handleAuthStatus(data) {
      var authenticated = data.authenticated;
      var serverUrl = data.serverUrl;
      
      if (authenticated && serverUrl) {
        isAuthenticated = true;
        currentServerUrl = serverUrl;
        authCode = data.authCode || '';
        
        if (serverUrlDisplayInput) {
          serverUrlDisplayInput.value = serverUrl;
        }
        
        showMainInterface();
        loadSettings();
      } else {
        isAuthenticated = false;
        showLoginForm();
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function () {
      setupEventListeners();
      
      // Load settings first
      loadSettings();
      
      // Initialize settings link
      updateSettingsLink();
      
      // Check authentication status
      checkAuthStatus();
      
      // Set focus to appropriate input after a short delay
      setTimeout(function() {
        if (isAuthenticated && titleInput) {
          titleInput.focus();
        } else if (!isAuthenticated && loginAuthCodeInput) {
          loginAuthCodeInput.focus();
        }
      }, 100);
    });
  </script>
</body>

</html>