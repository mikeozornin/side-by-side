<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Side by Side Voting</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 12px;
      line-height: 16px;
      color: #333;
      background: #ffffff;
      padding: 16px;
      height: 100vh;
      overflow: hidden;
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100%;
      gap: 16px;
    }

    .header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .title {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }

    .status {
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .status.info {
      background: #e3f2fd;
      color: #1976d2;
      border: 1px solid #bbdefb;
    }

    .status.error {
      background: #ffebee;
      color: #d32f2f;
      border: 1px solid #ffcdd2;
    }

    .status.success {
      background: #e8f5e8;
      color: #2e7d32;
      border: 1px solid #c8e6c9;
    }

    .status.warning {
      background: #fff3e0;
      color: #f57c00;
      border: 1px solid #ffcc02;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .label {
      display: block;
      font-size: 11px;
      font-weight: 500;
      color: #666;
      margin-bottom: 6px;
    }

    .input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      font-size: 12px;
      font-family: inherit;
      background: #fff;
      transition: border-color 0.2s;
    }

    .input:focus {
      outline: none;
      border-color: #1976d2;
      box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.1);
    }

    .input::placeholder {
      color: #999;
    }

    .duration-options {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: 6px;
      margin-top: 6px;
    }

    .duration-option {
      padding: 8px 12px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      background: #fff;
      cursor: pointer;
      text-align: center;
      font-size: 11px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .duration-option:hover {
      border-color: #1976d2;
      background: #f5f5f5;
    }

    .duration-option.selected {
      border-color: #1976d2;
      background: #1976d2;
      color: #fff;
    }

    .selected-elements {
      margin-top: 8px;
      display: flex;
      gap: 6px;
    }

    .element-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background: #f8f9fa;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
      flex: 1;
      box-sizing: border-box;
    }

    .element-name {
      font-size: 11px;
      color: #333;
      font-weight: 500;
    }

    .element-type {
      font-size: 10px;
      color: #666;
      text-transform: uppercase;
    }

    .button {
      width: 100%;
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }

    .button.primary {
      background: #1976d2;
      color: white;
    }

    .button.primary:hover:not(:disabled) {
      background: #1565c0;
    }

    .button.primary:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .button.secondary {
      background: #f5f5f5;
      color: #666;
      border: 1px solid #e0e0e0;
    }

    .button.secondary:hover {
      background: #eeeeee;
    }

    .progress {
      display: none;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: #e3f2fd;
      border-radius: 6px;
      font-size: 11px;
      color: #1976d2;
    }

    .spinner {
      width: 12px;
      height: 12px;
      border: 2px solid #e3f2fd;
      border-top: 2px solid #1976d2;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .hidden {
      display: none !important;
    }

    .footer {
      margin-top: auto;
      padding-top: 16px;
      border-top: 1px solid #e0e0e0;
    }

    .footer-text {
      font-size: 10px;
      color: #999;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">

    <div id="status" class="status info hidden">
      Checking selected elements...
    </div>

    <div class="form-group">
      <label class="label" for="server-url">Server URL</label>
      <input
        type="url"
        id="server-url"
        class="input"
        placeholder="example.com or https://example.com/votings"
        value="http://localhost:3000"
      />
    </div>

    <div id="selected-elements" class="selected-elements hidden">
<!-- Selected elements will be populated here -->
    </div>

    <form id="voting-form" class="hidden">
      <div class="form-group">
        <input
          type="text"
          id="title"
          class="input"
          maxlength="100"
        />
      </div>

      <div class="form-group">
        <div class="duration-options" id="duration-options">
          <div class="duration-option" data-duration="0.167">10 min</div>
          <div class="duration-option" data-duration="1">1 h</div>
          <div class="duration-option" data-duration="2">2 h</div>
          <div class="duration-option" data-duration="3">3 h</div>
          <div class="duration-option" data-duration="5">5 h</div>
          <div class="duration-option" data-duration="8">8 h</div>
          <div class="duration-option selected" data-duration="24">1 day</div>
          <div class="duration-option" data-duration="168">7 days</div>
        </div>
      </div>

      <div id="progress" class="progress">
        <div class="spinner"></div>
        <span id="progress-message">Creating voting...</span>
      </div>

      <div class="footer">
        <button type="submit" id="create-button" class="button primary" disabled>
          Create
        </button>
      </div>
    </form>

    <div class="footer" id="instruction-footer">
      <div class="footer-text">
        Select two elements in Figma to create a voting
      </div>
    </div>
  </div>

  <script>
    console.log('HTML loaded, starting inline script')

    // Inline JavaScript code - synchronized with client/src/i18n/locales/en.json
    const defaultQuestions = [
      "Which option is better?",
      "Left or right?",
      "Right or left?",
      "Which is better on the left or right?",
      "Which is better on the right or left?",
      "Which design do you like more?",
      "Which option is better?",
      "What would you choose?",
      "What would you prefer?"
    ]

    // DOM elements
    const statusEl = document.getElementById('status')
    const selectedElementsEl = document.getElementById('selected-elements')
    const votingFormEl = document.getElementById('voting-form')
    const titleInput = document.getElementById('title')
    const durationOptionsEl = document.getElementById('duration-options')
    const createButton = document.getElementById('create-button')
    const progressEl = document.getElementById('progress')
    const progressMessageEl = document.getElementById('progress-message')
    const instructionFooterEl = document.getElementById('instruction-footer')
    const serverUrlInput = document.getElementById('server-url')

    // State
    let selectedDuration = 24
    let selectedElements = []

    // Helper function to extract root URL from any URL
    function extractRootUrl(url) {
      try {
        // Add protocol if missing
        if (!url.startsWith('http://') && !url.startsWith('https://')) {
          url = 'https://' + url
        }

        const urlObj = new URL(url)
        return `${urlObj.protocol}//${urlObj.host}`
      } catch (error) {
        // If URL is invalid, return the original string
        return url
      }
    }

    console.log('DOM elements found:', {
      statusEl: !!statusEl,
      votingFormEl: !!votingFormEl,
      titleInput: !!titleInput
    })

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOMContentLoaded fired')
      setupEventListeners()
      setupTitleSuggestions()
      setupDurationOptions()
    })

    function setupEventListeners() {
      console.log('Setting up event listeners')
      votingFormEl?.addEventListener('submit', handleCreateVotingSubmit)
      titleInput?.addEventListener('input', () => {
        updateCreateButtonState()
      })
    }

    function setupTitleSuggestions() {
      const randomQuestion = defaultQuestions[Math.floor(Math.random() * defaultQuestions.length)]
      console.log('Setting random question:', randomQuestion)
      if (titleInput) {
        titleInput.value = randomQuestion
        console.log('Title input updated with:', titleInput.value)
        // Update button state after setting the value
        updateCreateButtonState()
      } else {
        console.error('titleInput not found!')
      }

    }

    function setupDurationOptions() {
      durationOptionsEl?.addEventListener('click', (e) => {
        const target = e.target
        if (target.classList.contains('duration-option')) {
          durationOptionsEl?.querySelectorAll('.duration-option').forEach(option => {
            option.classList.remove('selected')
          })
          target.classList.add('selected')
          selectedDuration = parseFloat(target.dataset.duration || '24')
        }
      })
    }

    function updateCreateButtonState() {
      const hasTitle = titleInput?.value.trim().length ? titleInput.value.trim().length > 0 : false
      const hasElements = selectedElements.length === 2

      if (createButton) {
        createButton.disabled = !hasTitle || !hasElements
      }
    }

    function handleCreateVotingSubmit(e) {
      e.preventDefault()

      const title = titleInput?.value.trim()
      if (!title) {
        showStatus('error', 'Enter voting title')
        return
      }

      if (selectedElements.length !== 2) {
        showStatus('error', 'Select exactly two elements')
        return
      }

      const serverUrl = serverUrlInput?.value.trim()
      if (!serverUrl) {
        showStatus('error', 'Enter server URL')
        return
      }

      // Extract root URL from the input
      const rootUrl = extractRootUrl(serverUrl)

      showProgress('Creating voting...')

      parent.postMessage({
        pluginMessage: {
          type: 'create-voting',
          data: {
            title,
            duration: selectedDuration,
            serverUrl: rootUrl
          }
        }
      }, '*')
    }

    function showStatus(type, message) {
      if (statusEl) {
        statusEl.className = `status ${type}`
        statusEl.innerHTML = message
        statusEl.classList.remove('hidden')
      }
      progressEl?.classList.add('hidden')
    }

    function showProgress(message) {
      if (progressMessageEl) {
        progressMessageEl.textContent = message
      }
      progressEl?.classList.remove('hidden')
      statusEl?.classList.add('hidden')
    }

    function hideProgress() {
      progressEl?.classList.add('hidden')
    }

    function updateSelectedElements(elements) {
      selectedElements = elements || []

      if (selectedElements.length === 0) {
        selectedElementsEl?.classList.add('hidden')
        // Show instruction when no elements selected
        instructionFooterEl?.classList.remove('hidden')
        return
      }

      if (selectedElementsEl) {
        selectedElementsEl.classList.remove('hidden')
        selectedElementsEl.innerHTML = selectedElements.map((element) => `
          <div class="element-item">
            <div class="element-name">${element.name}</div>
            <div class="element-type">${element.type}</div>
          </div>
        `).join('')
      }

      // Hide instruction when elements are selected
      instructionFooterEl?.classList.add('hidden')

      updateCreateButtonState()
    }

    // Listen for messages from plugin code
    window.addEventListener('message', (event) => {
      const { type, ...data } = event.data.pluginMessage || {}

      console.log('UI received message:', { type, data })

      switch (type) {
        case 'selection-status':
          handleSelectionStatus(data)
          break
        case 'export-progress':
          showProgress(data.message)
          break
        case 'voting-created':
          handleVotingCreated(data)
          break
        case 'error':
          handleError(data)
          break
      }
    })

    function handleSelectionStatus(data) {
      const { status, message, elements } = data

      console.log('handleSelectionStatus called with:', { status, message, elements })

      switch (status) {
        case 'none':
          showStatus('info', message)
          votingFormEl?.classList.add('hidden')
          updateSelectedElements([])
          break
        case 'partial':
          showStatus('warning', message)
          votingFormEl?.classList.add('hidden')
          updateSelectedElements([])
          break
        case 'too-many':
          showStatus('error', message)
          votingFormEl?.classList.add('hidden')
          updateSelectedElements([])
          break
        case 'ready':
          votingFormEl?.classList.remove('hidden')
          updateSelectedElements(elements)
          break
      }

      hideProgress()
    }

    function handleVotingCreated(data) {
      const { url, message } = data
      showStatus('success', `Voting created! <a href="${url}" target="_blank" style="color: #007AFF; text-decoration: underline;">${url}</a>`)

      setTimeout(() => {
        parent.postMessage({ pluginMessage: { type: 'close-plugin' } }, '*')
      }, 5000)
    }

    function handleError(data) {
      const { message } = data
      showStatus('error', message)
      hideProgress()
    }

    // Initialize create button state
    updateCreateButtonState()

    console.log('Inline script loaded successfully')
  </script>
</body>
</html>
